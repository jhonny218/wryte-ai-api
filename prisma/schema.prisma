// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// USER MODEL
// ============================================================================
model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique // Clerk's user ID (e.g., "user_2a1b2c3d")
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  organizationMemberships OrganizationMember[]

  @@index([clerkId]) // Fast lookup by Clerk ID
  @@map("users") // Table name in PostgreSQL
}

// ============================================================================
// ORGANIZATION MODEL
// Represents a company/team (Identity only)
// ============================================================================
model Organization {
  id   String @id @default(cuid())
  name String
  slug String @unique // For URLs: wryte.ai/org/acme-corp

  // Core Company Info
  mission     String? @db.Text // "To make AI accessible..."
  description String? @db.Text // "Acme Corp is a leading..."
  websiteUrl  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  members         OrganizationMember[]
  contentSettings ContentSettings?
  blogTitles      BlogTitle[]

  @@index([slug])
  @@map("organizations")
}

// ============================================================================
// CONTENT SETTINGS MODEL
// Configuration for content generation (Strategy & Preferences)
// ============================================================================
model ContentSettings {
  id             String @id @default(cuid())
  organizationId String @unique // 1:1 Relationship

  // Strategy
  primaryKeywords   String[]
  secondaryKeywords String[]
  frequency         String? // e.g., "WEEKLY", "MONTHLY"
  planningPeriod    String? // e.g., "QUARTERLY"

  // Style & Audience
  tone            String? // e.g., "professional", "witty"
  targetAudience  String? // e.g., "B2B SaaS founders"
  industry        String? // e.g., "Technology"
  goals           String[] // e.g., ["Lead Gen", "Brand Awareness"]
  competitorUrls  String[]
  topicsToAvoid   String[]
  preferredLength String? // e.g., "SHORT_FORM"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("content_settings")
}

// ============================================================================
// ORGANIZATION MEMBER MODEL
// Join table for User <-> Organization with roles
// ============================================================================
model OrganizationMember {
  id             String           @id @default(cuid())
  organizationId String
  userId         String
  role           OrganizationRole @default(OWNER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId]) // User can join an org only once
  @@index([userId])
  @@index([organizationId])
  @@map("organization_members")
}

enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER
}

// ============================================================================
// BLOG TITLE MODEL
// Individual blog title generated by AI
// ============================================================================
model BlogTitle {
  id             String @id @default(cuid())
  organizationId String

  title  String // e.g., "10 Ways AI is Transforming SaaS in 2024"
  status TitleStatus @default(PENDING)

  scheduledDate DateTime? // When this blog should be published

  // AI Context (for regeneration)
  aiGenerationContext Json? // Stores the prompt/context used to generate this title
  // Useful for regenerating or understanding AI decisions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  outline      BlogOutline? // Optional: Title might not have outline yet

  @@index([organizationId, status]) // Fast query: "Get all approved titles for this org"
  @@index([scheduledDate]) // Fast query: "Get all titles for January 2024"
  @@map("blog_titles")
}

enum TitleStatus {
  PENDING // Just generated, waiting for user review
  APPROVED // User approved
  REJECTED // User explicitly rejected
  REGENERATING // AI is generating a new version
}

// ============================================================================
// BLOG OUTLINE MODEL
// AI-generated blog structure/layout
// ============================================================================
model BlogOutline {
  id          String @id @default(cuid())
  blogTitleId String @unique // One outline per title

  // Outline structure
  structure Json // {
  //   "introduction": { "summary": "...", "keyPoints": [...] },
  //   "sections": [
  //     { "heading": "...", "subheadings": [...], "points": [...] },
  //     ...
  //   ],
  //   "conclusion": { "summary": "...", "cta": "..." }
  // }

  // SEO Metadata
  seoKeywords     String[] // e.g., ["AI blogging", "content strategy"]
  metaDescription String? // For <meta name="description">
  suggestedImages String[] // URLs or descriptions of suggested images

  status OutlineStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  blogTitle BlogTitle @relation(fields: [blogTitleId], references: [id], onDelete: Cascade)
  fullBlog  FullBlog?

  @@index([status])
  @@map("blog_outlines")
}

enum OutlineStatus {
  PENDING
  APPROVED
  REJECTED
  REGENERATING
}

// ============================================================================
// FULL BLOG MODEL
// Complete blog post generated by AI
// ============================================================================
model FullBlog {
  id            String @id @default(cuid())
  blogOutlineId String @unique // One blog per outline

  // Content
  content     String @db.Text // Markdown content
  htmlContent String @db.Text // HTML version (for preview/export)
  wordCount   Int

  // Metadata
  status      BlogStatus @default(DRAFT)
  publishedAt DateTime? // When published to external CMS
  exportedAt  DateTime? // When exported (PDF/DOCX)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  outline BlogOutline @relation(fields: [blogOutlineId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([publishedAt])
  @@map("full_blogs")
}

enum BlogStatus {
  DRAFT // Generated, not finalized
  APPROVED // User approved
  PUBLISHED // Published to external platform
  EXPORTED // Exported as file
}

// ============================================================================
// JOB MODEL (Optional but recommended)
// Tracks async jobs for observability
// ============================================================================
model Job {
  id             String    @id @default(cuid())
  userId         String // Who initiated this job
  organizationId String? // Which org this job belongs to
  type           JobType // What kind of job
  status         JobStatus @default(PENDING)

  // Input/Output
  input  Json? // Input parameters
  result Json? // Result data when completed
  error  String? // Error message if failed

  // Metadata
  attempts    Int @default(0)
  maxAttempts Int @default(3)

  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([organizationId, status])
  @@index([userId, status])
  @@index([type, status])
  @@map("jobs")
}

enum JobType {
  GENERATE_TITLES
  GENERATE_OUTLINE
  GENERATE_BLOG
  REGENERATE_CONTENT
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
